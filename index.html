<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Maill'haie interactive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Google Font Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { margin:0; padding:0; height:100%; font-family:'Poppins',sans-serif; }
    #header {
      position:fixed; top:0; left:0; right:0; height:60px; background:#fff;
      border-bottom:1px solid #ccc; display:flex; align-items:center; justify-content:space-between;
      padding:0 15px; z-index:1002;
    }
    .brand { display:flex; align-items:center; }
    .tree-icon { font-size:1.3em; margin-right:6px; }
    .brand-name { font-size:1.1em; font-weight:600; color:#2c3e50; }
    .header-text { font-size:0.75em; color:#555; margin-left:8px; }
    .icons a { margin-left:10px; font-size:1.1em; color:#333; text-decoration:none; }
    #controls {
      position:absolute; top:70px; left:8px; max-width:220px; background:white;
      padding:8px; border-radius:6px; box-shadow:0 0 8px rgba(0,0,0,0.2);
      z-index:1001; font-size:11px;
    }
    #controls select, #controls button {
      width:85%;
      margin-top:5px;
    }
    #controls label { margin-top:10px; font-size:11px; font-weight:600; }
    #legend {
      position:absolute; top:70px; right:8px; background:white; padding:8px;
      border-radius:6px; box-shadow:0 0 8px rgba(0,0,0,0.2);
      z-index:1001; font-size:11px;
    }
    #legend label { display:flex; align-items:center; margin-bottom:4px; }
    .color-box { width:13px; height:13px; margin-right:6px; border:1px solid #333; }
    #map { position:absolute; top:60px; bottom:0; left:0; right:0; }
    .label-rang {
      font-size:11px; font-weight:bold; color:black;
      text-shadow:1px 1px 1px white,-1px 1px 1px white,1px -1px 1px white,-1px -1px 1px white;
      transform: translateX(6px); pointer-events:none;
    }
    .label-tirag { font-size:11px; color:black; pointer-events:none; }
    /* Style du contr√¥le de recherche bottomleft */
    .leaflet-control-search {
      background: white;
      padding: 4px;
      border-radius: 4px;
      box-shadow: 0 0 4px rgba(0,0,0,0.3);
    }
    .leaflet-control-search input {
      width: 150px;
      padding: 2px 4px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div id="header">
    <div class="brand">
      <span class="tree-icon">üå≥</span>
      <span class="brand-name">Maill'haie</span>
      <span class="header-text">Application de rep√©rage des mailles du suivi du bocage</span>
    </div>
    <div class="icons">
      <a href="modedemploi.html" title="Mode d'emploi">üìñ</a>
      <a href="information.html" title="Informations">‚ÑπÔ∏è</a>
      <a href="#" onclick="showInstallInstructions()" title="Ajouter √† l'accueil">üì±</a>
    </div>
  </div>

  <div id="controls">
    <button id="geolocateBtn" onclick="geolocate()">üìç Localisez-moi</button>
    <button id="reloadButton" style="display:none" onclick="location.reload()">Changer de d√©partement</button>
    <select id="departementSelect" onchange="onDeptChange(this.value)">
      <option value="">-- Choisir un d√©partement --</option>
    </select>
    <select id="labelFilterSelect" style="display:none;" onchange="applyFilters()">
      <option value="">Filtrer par N¬∞ maille</option>
    </select>
    <button id="subdivideBtn" style="display:none" onclick="toggleSubMailles()">Afficher sous-mailles</button>
  </div>

  <div id="legend">
    <strong>Afficher :</strong><br/>
    <div id="checkboxes"></div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://ignf.github.io/geoportal-extensions/leaflet-latest/dist/GpPluginLeaflet.js"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <script>
    // Initialisation carte et couches
    const map = L.map('map',{zoomControl:false}).setView([46.6,2.5],6);
    Gp.Services.getConfig({
      apiKey:"essentiels",
      onSuccess:config=>{
        const osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OSM'}).addTo(map);
        const ortho=L.geoportalLayer.WMTS({layer:"ORTHOIMAGERY.ORTHOPHOTOS"});
        const plan=L.geoportalLayer.WMTS({layer:"GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2"});
        L.control.layers({"OSM":osm,"Ortho":ortho,"Plan":plan},null,{position:'bottomleft'}).addTo(map);
        addSearchControl();
      }
    });

    // Ajout du contr√¥le de recherche bottomleft
    function addSearchControl(){
      const SearchControl = L.Control.extend({
        options: { position: 'bottomleft' },
        onAdd: function(map){
          const container = L.DomUtil.create('div','leaflet-control-search');
          container.innerHTML = '<input id="searchCommune" list="suggestions" placeholder="Commune" autocomplete="off"/><datalist id="suggestions"></datalist>';
          L.DomEvent.disableClickPropagation(container);
          return container;
        }
      });
      map.addControl(new SearchControl());
      const input = document.getElementById('searchCommune');
      const datalist = document.getElementById('suggestions');
      input.addEventListener('input', () => {
        const v = input.value; if(v.length<3) return;
        fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(v)}&type=municipality`)
          .then(r=>r.json()).then(data=>{
            datalist.innerHTML='';
            data.features.forEach(f=>{
              const opt = document.createElement('option');
              opt.value = f.properties.name;
              opt.dataset.lat = f.geometry.coordinates[1];
              opt.dataset.lon = f.geometry.coordinates[0];
              datalist.appendChild(opt);
            });
          });
      });
      input.addEventListener('change', ()=>{
        const val = input.value;
        Array.from(datalist.options).forEach(opt=>{
          if(opt.value === val){
            map.setView([opt.dataset.lat,opt.dataset.lon],12);
          }
        });
      });
    }

    // Chargement GeoJSON d√©partements et mailles
    let dptPolygons, fullData, mailleLayer, subdivLayer;
    const colors={0:"#888",1:"#1f78b4",2:"#33a02c",3:"#e31a1c",4:"#ff7f00",5:"#6a3d9a"};
    const activeRangs=new Set([0,1,2,3,4,5]);
    const dptLayer=L.geoJSON(null,{style:{color:"#33cc33",weight:2,fillColor:"#33cc33",fillOpacity:0.05}}).addTo(map);
    const visibleLabels=L.layerGroup().addTo(map);
    fetch('geojson/dpt_4326_simplif100.geojson').then(r=>r.json()).then(data=>{
      dptPolygons=data;
      const sel=document.getElementById("departementSelect");
      data.features.sort((a,b)=>a.properties.nom_m.localeCompare(b.properties.nom_m))
          .forEach(f=>{const o=document.createElement("option");
            o.value=f.properties.insee_dep;
            o.text=`${f.properties.nom_m} (${f.properties.insee_dep})`;
            sel.appendChild(o);
          });
    });
    fetch('geojson/remplacantes_label.geojson').then(r=>r.json()).then(data=>{
      fullData=data;
      const cbCont=document.getElementById("checkboxes");
      Object.entries(colors).forEach(([rang,color])=>{
        const lbl=document.createElement("label");
        lbl.innerHTML=`<div class="color-box" style="background:${color}"></div>
          <input type="checkbox" value="${rang}" checked onchange="applyFilters()"> 
          ${rang===0?"Maille initiale":"Rempla√ßante "+rang}`;
        cbCont.appendChild(lbl);
      });
    });

    // Fonctions de filtrage et affichage des mailles (comme pr√©c√©demment)
    function onDeptChange(code){ /* ... */ }
    function applyFilters(){ /* ... */ }
    function zoomToDepartement(code){ /* ... */ }
    function showMaillesForDept(code){ /* ... */ }
    function toggleSubMailles(){ /* ... */ }
    function geolocate(){ /* ... */ }

    function showInstallInstructions(){
      alert("Pour ajouter Maill'haie √† votre √©cran d'accueil, utilisez le menu du navigateur et s√©lectionnez 'Ajouter √† l'√©cran d'accueil'.");
    }
  </script>
</body>
</html>
