<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Maill'haie interactive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Google Font Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap" rel="stylesheet">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
    #header {
      position: fixed; top:0; left:0; right:0; height:60px; background:#fff;
      border-bottom:1px solid #ccc; display:flex; align-items:center; justify-content:space-between;
      padding:0 15px; z-index:1002;
    }
    .brand { display:flex; align-items:center; }
    .tree-icon { font-size:1.3em; margin-right:6px; } /* r√©duit de ~15% */
    .brand-name { font-family:'Poppins',sans-serif; font-size:1.1em; font-weight:600; color:#2c3e50; } /* r√©duit */
    .header-text { font-size:0.75em; color:#555; margin-left:8px; } /* r√©duit */
    .icons a { margin-left:10px; font-size:1.1em; color:#333; text-decoration:none; } /* r√©duit */
    #controls {
      position:absolute; top:70px; left:8px; max-width:200px; background:white;
      padding:8px; border-radius:6px; box-shadow:0 0 8px rgba(0,0,0,0.2);
      z-index:1001; font-size:11px; /* r√©duit */
    }
    #controls select, #controls button { width:85%; } /* r√©duit largeur */
    #legend {
      position:absolute; top:70px; right:8px; background:white; padding:8px;
      border-radius:6px; box-shadow:0 0 8px rgba(0,0,0,0.2);
      z-index:1001; font-size:11px; /* r√©duit de ~15% */
    }
    #legend label { display:flex; align-items:center; margin-bottom:4px; font-size:11px; }
    #map { position:absolute; top:60px; bottom:0; left:0; right:0; }
    .label-rang {
      font-size:11px; font-weight:bold; color:black;
      text-shadow:1px 1px 1px white,-1px 1px 1px white,1px -1px 1px white,-1px -1px 1px white;
      transform: translateX(6px); /* r√©duit d√©calage */
      pointer-events:none;
    }
    .label-tirag {
      font-size:11px; color:black; pointer-events:none;
    }
    .color-box { width:13px; height:13px; margin-right:6px; border:1px solid #333; } /* r√©duit */
    .leaflet-control-layers { z-index:1001 !important; }
  </style>
</head>
<body>
  <div id="header">
    <div class="brand">
      <span class="tree-icon">üå≥</span>
      <span class="brand-name">Maill'haie</span>
      <span class="header-text">Application de rep√©rage des mailles du suivi du bocage</span>
    </div>
    <div class="icons">
      <a href="modedemploi.html" title="Mode d'emploi">üìñ</a>
      <a href="information.html" title="Informations">‚ÑπÔ∏è</a>
      <a href="#" onclick="showInstallInstructions()" title="Ajouter √† l'accueil">üì±</a>
    </div>
  </div>

  <div id="controls">
    <button id="geolocateBtn" onclick="geolocate()">üìç Localisez-moi</button>
    <button id="reloadButton" style="display:none" onclick="location.reload()">Changer de d√©partement</button>
    <select id="departementSelect" onchange="onDeptChange(this.value)">
      <option value="">-- Choisir un d√©partement --</option>
    </select>
    <select id="labelFilterSelect" style="display:none" onchange="applyFilters()">
      <option value="">Filtrer par Num√©ro de la maille</option>
    </select>
    <button id="subdivideBtn" style="display:none" onclick="toggleSubMailles()">Afficher les sous-mailles</button>
  </div>

  <div id="legend">
    <strong>Afficher :</strong><br/>
    <div id="checkboxes"></div>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://ignf.github.io/geoportal-extensions/leaflet-latest/dist/GpPluginLeaflet.js"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <script>
    const map = L.map('map',{zoomControl:false}).setView([46.6,2.5],6);
    Gp.Services.getConfig({
      apiKey:"essentiels",
      onSuccess:config=>{
        const osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'});
        const ortho=L.geoportalLayer.WMTS({layer:"ORTHOIMAGERY.ORTHOPHOTOS"});
        const plan=L.geoportalLayer.WMTS({layer:"GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2"});
        osm.addTo(map);
        L.control.layers({"OSM":osm,"Ortho IGN":ortho,"Plan IGN":plan},null,{position:'bottomleft'}).addTo(map);
      },
      onError:err=>console.error("Erreur IGN:",err)
    });
    let dptPolygons, fullData, mailleLayer, subdivLayer;
    const colors={0:"#888",1:"#1f78b4",2:"#33a02c",3:"#e31a1c",4:"#ff7f00",5:"#6a3d9a"};
    const activeRangs=new Set([0,1,2,3,4,5]);
    const dptLayer = L.geoJSON(null,{style:{color:"#33cc33",weight:2,fillColor:"#33cc33",fillOpacity:0.05}}).addTo(map);
    const visibleLabels = L.layerGroup().addTo(map);
    fetch('geojson/dpt_4326_simplif100.geojson').then(r=>r.json()).then(data=>{
      dptPolygons=data;
      const sel=document.getElementById("departementSelect");
      data.features.sort((a,b)=>a.properties.nom_m.localeCompare(b.properties.nom_m)).forEach(f=>{
        const o=document.createElement("option"); o.value=f.properties.insee_dep;
        o.text=`${f.properties.nom_m} (${f.properties.insee_dep})`; sel.appendChild(o);
      });
    });
    fetch('geojson/remplacantes_label.geojson').then(r=>r.json()).then(data=>{
      fullData=data;
      const cbCont=document.getElementById("checkboxes");
      Object.entries(colors).forEach(([rang,color])=>{
        const lbl=document.createElement("label");
        const text = rang==0 ? "Maille initiale" : "Rempla√ßante "+rang;
        lbl.innerHTML=`<div class="color-box" style="background:${color}"></div>
          <input type="checkbox" value="${rang}" checked onchange="applyFilters()"> ${text}`;
        cbCont.appendChild(lbl);
      });
    });
    function onDeptChange(code){
      if(!code)return;
      zoomToDepartement(code);
      showMaillesForDept(code);
      document.getElementById("reloadButton").style.display='inline-block';
      document.getElementById("departementSelect").disabled=true;
      document.getElementById("geolocateBtn").disabled=true;
      const lf=document.getElementById("labelFilterSelect");
      lf.style.display='inline-block';
      lf.innerHTML='<option value="">Filtrer par Num√©ro de la maille</option>';
      const prefixes=fullData.features.map(f=>parseInt(f.properties.label_dsb,10));
      const max=Math.max(...prefixes);
      for(let i=1;i<=max;i++){ const o=document.createElement("option"); o.value=i; o.text=i; lf.appendChild(o); }
      document.getElementById("subdivideBtn").style.display='inline-block';
    }
    function applyFilters(){
      const labelFilter=document.getElementById("labelFilterSelect").value;
      activeRangs.clear();
      document.querySelectorAll('#checkboxes input').forEach(cb=>{ if(cb.checked) activeRangs.add(+cb.value); });
      if(mailleLayer) map.removeLayer(mailleLayer);
      visibleLabels.clearLayers();
      const filtered=fullData.features.filter(f=>{
        if(!activeRangs.has(f.properties.rang_sourc||0)) return false;
        if(labelFilter && !f.properties.label_dsb.startsWith(labelFilter)) return false;
        return true;
      });
      mailleLayer=L.geoJSON(filtered,{
        style:f=>({color:colors[f.properties.rang_sourc||0]||"#999",weight:1,fillOpacity:0.4}),
        onEachFeature:(f,layer)=>{
          const c=layer.getBounds().getCenter();
          L.marker(c,{icon:L.divIcon({className:'label-rang',html:f.properties.label_dsb,iconSize:[20,20]})})
            .addTo(visibleLabels);
          layer.bindPopup(`<b>CODE_1KM:</b>${f.properties.CODE_1KM}<br/><b>Rang:</b>${f.properties.rang_sourc||0}`);
        }
      }).addTo(map);
    }
    function zoomToDepartement(code){
      const feat=dptPolygons.features.find(f=>f.properties.insee_dep==code);
      if(feat){ dptLayer.clearLayers().addData(feat); map.fitBounds(L.geoJSON(feat).getBounds()); }
    }
    function showMaillesForDept(code){
      fullData={...fullData,features:fullData.features.filter(f=>f.properties.ID_DEPT==code)};
      applyFilters();
    }
    function toggleSubMailles(){
      const btn=document.getElementById("subdivideBtn");
      if(subdivLayer){ map.removeLayer(subdivLayer); subdivLayer=null; btn.textContent="Afficher les sous-mailles"; return; }
      fetch('geojson/mailles_250.geojson').then(r=>r.json()).then(data=>{
        const codes=new Set(fullData.features.map(f=>f.properties.CODE_1KM));
        subdivLayer=L.geoJSON(data.features.filter(f=>codes.has(f.properties.code_1km)),{
          style:{color:'#1f78b4',weight:1,fillOpacity:0.2},
          onEachFeature:(f,layer)=>{
            const n=parseInt(f.properties.rang_tirag.slice(1),10);
            const weight=Math.round(1000-(n-1)*60);
            const col=(n-1)%4; const offsetX=(col<2?-8:8);
            const c=layer.getBounds().getCenter();
            L.marker(c,{icon:L.divIcon({className:'label-tirag',html:n,iconSize:[20,20],iconAnchor:[offsetX,0],style:'font-weight:'+weight}),interactive:false}).addTo(map);
          }
        }).addTo(map);
        btn.textContent="Masquer les sous-mailles";
      });
    }
    function geolocate(){
      navigator.geolocation.getCurrentPosition(pos=>{
        const pt=turf.point([pos.coords.longitude,pos.coords.latitude]);
        const cont=dptPolygons.features.find(f=>turf.booleanPointInPolygon(pt,f));
        if(cont){
          const code=cont.properties.insee_dep;
          document.getElementById("departementSelect").value=code;
          document.getElementById("departementSelect").disabled=true;
          document.getElementById("reloadButton").style.display='inline-block';
          document.getElementById("geolocateBtn").disabled=true;
          onDeptChange(code);
        }
        L.circleMarker([pos.coords.latitude,pos.coords.longitude],{radius:6,color:'red'}).addTo(map).bindPopup("Vous √™tes ici").openPopup();
      },()=>alert("G√©olocalisation impossible"));
    }
    function showInstallInstructions(){
      alert("Pour ajouter Maill'haie √† votre √©cran d'accueil, utilisez le menu du navigateur et s√©lectionnez 'Ajouter √† l'√©cran d'accueil'.");
    }
  </script>
</body>
</html>